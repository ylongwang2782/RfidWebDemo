<!DOCTYPE html>
<html lang="en">
<!-- <pre id="debug_area">数据加载中...</pre> -->
<!-- this is for DT50 -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tag Access</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            margin: 5px;
        }

        .horizontal-container {
            display: flex;
            flex-direction: row;
            margin: 5px 0;
        }

        .checkbox-container,
        .input-container,
        .button-container {
            display: flex;
            flex-direction: row;
            align-items: center;

        }

        .checkbox-container input,
        .input-container input,
        .input-container select,
        .button-container button {
            margin: 0 5px;
        }

        .input-container label {
            width: 100px;
        }

        .input-container input,
        .input-container select {
            flex-grow: 1;
            height: 35px;
        }

        .button-container button {
            width: 100%;
            height: 40px;
            margin: 5px 0;
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Spinner for EPCs -->
        <div class="input-container">
            <label for="sp_access_epc_list">EPCs:</label>
            <input type="text" id="sp_access_epc_list"></select>
        </div>

        <div class="input-container">
            <label for="sp_access_epc_ascii_list">EPCs(ASCII):</label>
            <input type="text" id="sp_access_epc_ascii_list"></select>
        </div>

        <!-- Inventory Button -->
        <div class="button-container">
            <button id="btn_access_inventory">开始盘点</button>
        </div>

        <!-- Memory Bank -->
        <div class="input-container">
            <label for="sp_access_memory_bank">Memory Bank:</label>
            <select id="sp_access_memory_bank"></select>
        </div>

        <!-- Word Start -->
        <div class="input-container">
            <label for="sp_access_word_start">Word Start:</label>
            <select id="sp_access_word_start"></select>
        </div>

        <!-- Word Count -->
        <div class="input-container">
            <label for="sp_access_word_count">Word Count:</label>
            <select id="sp_access_word_count"></select>
        </div>

        <!-- Access PWB -->
        <div class="input-container">
            <label for="ed_access_access_pwb">Access PWB:</label>
            <input type="text" id="ed_access_access_pwb" value="00000000" pattern="[0-9a-fA-F]*">
        </div>

        <!-- Data (Hex) -->
        <div class="input-container">
            <label for="ed_access_data">Data(Hex):</label>
            <input type="text" id="ed_access_data" value="0000" pattern="[0-9a-fA-F]*">
        </div>

        <!-- Write Button -->
        <div class="button-container">
            <button id="btn_access_hex_write">Hex写入</button>
        </div>

        <!-- Data (ASCII) -->
        <div class="input-container">
            <label for="ed_access_ascii">Data(ASCII):</label>
            <input type="text" id="ed_access_ascii">
        </div>

        <!-- Write Button -->
        <div class="button-container">
            <button id="btn_access_ascii_write">ASCII写入</button>
        </div>

        <div class="button-container">
            <button id="btn_clear_focus">清除焦点</button>
        </div>

    </div>

    <script>

        // initial memory_bank element
        var memoryBankSelect = document.getElementById('sp_access_memory_bank');
        var wordStartSelect = document.getElementById('sp_access_word_start');
        var wordCountSelect = document.getElementById('sp_access_word_count');
        var options = [
            { value: '00', text: 'RFU' },
            { value: '01', text: 'EPC' },
            { value: '02', text: 'TID' },
            { value: '03', text: 'USER' }
        ];
        options.forEach(function (option) {
            var newOption = document.createElement('option');
            newOption.value = option.value;
            newOption.text = option.text;
            memoryBankSelect.add(newOption);
        });
        memoryBankSelect.value = '01';
        // 获取word start下拉框元素，循环生成选项并添加到下拉框中
        for (var i = 0; i <= 255; i++) {
            var option = document.createElement('option');
            option.value = i;
            option.text = i;
            wordStartSelect.add(option);
        }
        wordStartSelect.value = 2;
        // 获取word count下拉框元素，循环生成选项并添加到下拉框中
        for (var i = 0; i <= 255; i++) {
            var option = document.createElement('option');
            option.value = i;
            option.text = i;
            wordCountSelect.add(option);
        }
        wordCountSelect.value = 1;

        function onKeyDownHandler() {
            const accessButton = document.getElementById('btn_access_inventory');
            accessButton.textContent = '停止盘点';
        }

        function onKeyUpHandler() {
            const accessButton = document.getElementById('btn_access_inventory');
            accessButton.textContent = '开始盘点';
        }

        document.getElementById('btn_access_inventory').addEventListener('click', function () {
            toggle_btn_access_inventory();

            const jsonSpinnerInventoryData = JSON.parse(AndroidEpc.startSpinnerInventory());

            // 更新epc hex
            const epcHexElement = document.getElementById('sp_access_epc_list');
            if (epcHexElement) {
                epcHexElement.value = jsonSpinnerInventoryData;
            }

            // 更新epc ASCII
            const epcAsciiElement = document.getElementById('sp_access_epc_ascii_list');
            if (epcAsciiElement) {
                const hexString = jsonSpinnerInventoryData.replace(/\s/g, '');
                let asciiString = '';
                for (let i = 0; i < hexString.length; i += 2) {
                    const hexChar = hexString.substr(i, 2);
                    if (hexChar.match(/[0-9a-fA-F]{2}/)) {
                        asciiString += String.fromCharCode(parseInt(hexChar, 16));
                    }
                }
                epcAsciiElement.value = asciiString;
            }

        });

        document.getElementById('btn_access_hex_write').addEventListener('click', function () {
            const selectElement = document.getElementById('sp_access_epc_list');
            // epcPos固定为0
            epcsPos = 0;
            // memTypePos固定为2
            memTypePos = 2;
            // 起始字节位置固定为2
            wordStartPos = 2;
            // wordCount = wordCountSelect.selectedIndex;
            const accessPwd = document.getElementById('ed_access_access_pwb').value;

            AndroidEpc.startSpinnerInventory()
            const accessData = document.getElementById('ed_access_data').value;
            wordCount = Math.ceil(accessData.length / 4)

            AndroidEpc.htmlAccessInventory(epcsPos, memTypePos, wordStartPos, wordCount, accessPwd, accessData);
        });

        // 为ASCII输入框添加回车触发条件
        document.getElementById('ed_access_ascii').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // 阻止默认行为（如换行）
                document.getElementById('btn_access_ascii_write').click(); // 触发点击事件
            }
        });

        document.getElementById('btn_access_ascii_write').addEventListener('click', function () {
            const selectElement = document.getElementById('sp_access_epc_list');
            // epcPos固定为0
            epcsPos = 0;
            // memTypePos固定为2
            memTypePos = 2;
            // 起始字节位置固定为2
            wordStartPos = 2;
            const accessPwd = document.getElementById('ed_access_access_pwb').value;

            // 重试
            function executeWithRetry(retryCount = 3) {
                try {
                    AndroidEpc.startSpinnerInventory();

                    // 获取ASCII数据并转换为HEX
                    const asciiData = document.getElementById('ed_access_ascii').value;
                    let hexData = '';
                    for (let i = 0; i < asciiData.length; i++) {
                        const hexChar = asciiData.charCodeAt(i).toString(16).padStart(2, '0');
                        hexData += hexChar;
                    }
                    wordCount = Math.ceil(hexData.length / 4);

                    // 使用转换后的HEX数据进行写入
                    AndroidEpc.htmlAccessInventory(epcsPos, memTypePos, wordStartPos, wordCount, accessPwd, hexData);

                    // 写完后立即进行读取，进行数据校验
                    document.getElementById('btn_access_inventory').click();
                } catch (error) {
                    console.error('执行失败，重试中...', error);
                    if (retryCount > 0) {
                        setTimeout(() => executeWithRetry(retryCount - 1), 200); // 1秒后重试
                    } else {
                        console.error('重试次数用尽，操作失败');
                    }
                }
            }

            executeWithRetry(); // 首次执行
        });

        function toggle_btn_access_inventory() {
            const accessButton = document.getElementById('btn_access_inventory');
            if (accessButton.textContent === '停止盘点') {
                accessButton.textContent = '开始盘点';
            }
            else if (accessButton.textContent === '开始盘点') {
                accessButton.textContent = '停止盘点';
            }
        }

        function debugMethod() {
            const checkboxes = document.querySelectorAll('.checkbox-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
            });
        }

        document.getElementById('tab_inventory_page').addEventListener('click', function () {
            window.location.href = 'http://192.168.0.100:8083/';
        });

        document.cookie.split(";").forEach(function (c) {
            document.cookie = c.trim().split("=")[0] + "=;expires=" + new Date(0).toUTCString() + ";path=/";
        });

    </script>
</body>

</html>